<h4><p class="text-muted">Manage current Wildcat News Stories, and approve new requests.</p></h4>
<a href="/app/dashboard"><button class="btn btn-primary btn-back">Cancel</button></a>
<h4 id="newLabel">New User Requests</h4>
<div id="newUsers">

</div>
<hr style="border-color:#561838";></hr>
<h4 id="existingLabel">Existing Users</h4><input type="text" id="search" placeholder=" SEARCH">
<br><br>
<div id="existingUsers">

</div>
<script>

    loadPage();

    var requests = new Array();
    var current = new Array();

    function loadPage(message) {
        $("#newUsers").html("");
        $("#existingUsers").html("");
        setLoadingMessage("Loading users...");
        $("#loading").fadeIn();
        $.ajax({
            url: "manage/ajax/load",
            type: "post",
            data: {key: "value"}, // Encrypt all data...
            datatype: 'json',
            crossDomain: true,

            success: function(response){
                requests = response["requests"];
                current = response["current"];
                if (requests != null && current != null) {
                    if (requests.length > 0) {
                        loadNewTable();
                    } else {
                        $("#titleLabel").html("New User Requests Requests");
                        $("#newsRequests").html('<h4><span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>There are currently no active news requests.</h4>');
                    }
                    if (current.length > 0) {
                        loadCurrentTable();
                    } else {
                        $("#existingLabel").html("Existing Users");
                        $("#currentNews").html('<h4><span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>There are currently no active news stories.</h4>');
                    }
                    if (message != null)
                        setMessage(message, false);
                    $("#loading").fadeOut();
                } else {
                    setMessage("Unable to load news articles. Please try to reload the page.", true);
                    $("#loading").fadeOut();
                }
            },

            error: function(request, status, error) {
                setMessage("Internal server error. If this problem continues, please contact support.", true);
                $("#loading").fadeOut();
            }
        });
    }

    function loadNewTable() {
        $("#newLabel").html("New User Requests (" + requests.length+")");

        var tableDiv = document.getElementById("newUsers");
        var table = document.createElement("TABLE");
        var tableBody = document.createElement("TBODY");

        $("#newUsers").html("");

        table.appendChild(tableBody);
        table.className = "table table-striped";

        var heading = new Array();
        heading[0] = "Last Name";
        heading[1] = "First Name";
        heading[2] = "E-Mail";
        heading[3] = "Action";

        //TABLE COLUMNS

        var tr = document.createElement("TR");
        tableBody.appendChild(tr);

        for (var i = 0; i < heading.length; i++) {
            var th = document.createElement("TH");
            th.width = '25%';
            th.appendChild(document.createTextNode(heading[i]));
            tr.appendChild(th);
        };

        window.userArray = new Array();

        for (var i = 0; i < requests.length; i++) {
            window.userArray.push(requests[i]);
            var tr = document.createElement("TR");
            var tdTwo = document.createElement("TD");
            tdTwo.appendChild(document.createTextNode(requests[i]["lastName"]));
            tr.appendChild(tdTwo);
            var tdOne = document.createElement("TD");
            tdOne.appendChild(document.createTextNode(requests[i]["firstName"]));
            tr.appendChild(tdOne);
            var tdThree = document.createElement("TD");
            tdThree.innerHTML = '<a href="mailto:'+requests[i]["email"]+'">'+requests[i]["email"]+'</a>';
            tr.appendChild(tdThree);
            var tdFour = document.createElement("TD");
            var button =document.createElement("INPUT");
            button.type = "button";
            button.className = "btn btn-lg btn-primary approve";
            button.value = "Approve";
            button.name = i;
            button.style.marginRight = "10px";
            tdFour.appendChild(button);

            var buttonTwo =document.createElement("INPUT");
            buttonTwo.type = "button";
            buttonTwo.className = "btn btn-lg btn-primary";
            buttonTwo.value = "Deny";
            button.name = i;
            buttonTwo.style.marginRight = "10px";
            buttonTwo.style.backgroundColor = "red";
            buttonTwo.style.borderColor = "red";
            buttonTwo.onclick = (function() {
                var count = i;

                return function(e) {

                    BootstrapDialog.confirm({
                        title: 'Confirmation',
                        message: 'Are you sure you want to deny this user?',
                        type: BootstrapDialog.TYPE_DANGER, // <-- Default value is BootstrapDialog.TYPE_PRIMARY
                        closable: true, // <-- Default value is false
                        draggable: true, // <-- Default value is false
                        btnCancelLabel: 'No', // <-- Default value is 'Cancel',
                        btnOKLabel: 'Yes', // <-- Default value is 'OK',
                        btnOKClass: 'btn-primary', // <-- If you didn't specify it, dialog type will be used,
                        callback: function(result) {
                            // result will be true if button was click, while it will be false if users close the dialog directly.
                            if(result) {
                                $("#spinnerDiv").html('<a><img src="./../spinner.gif" alt="Logo" width="40" style="vertical-align: middle; padding-top:12px; padding-left:10px;"/></a>');

                                var user = window.userArray[count];

                                var query = new Parse.Query("UserRegisterStructure");
                                query.equalTo("username", user.get("username"));
                                query.first({
                                    success: function(object) {
                                        object.destroy({
                                            success: function(object) {
                                                $("#spinnerDiv").html("");
                                                var alertString = "User successfully denied account request.";
                                                localStorage.setItem("userAlertString", alertString);
                                                $(document).ready(loadNewUserTable());
                                                $(document).ready(loadExistingUserTable());
                                            },
                                            error: function(error) {
                                                errorFunction(error.code.toString() + " - " + error.message.toString(), "ParseError", "Script 1500");
                                                BootstrapDialog.show({
                                                    type: BootstrapDialog.TYPE_DEFAULT,
                                                    title: "Error",
                                                    message: "Error occurred. Please try again."
                                                });
                                                $("#spinnerDiv").html("");
                                            }
                                        });
                                    },
                                    error: function(error) {
                                        errorFunction(error.code.toString() + " - " + error.message.toString(), "ParseError", "Script 1511");
                                        BootstrapDialog.show({
                                            type: BootstrapDialog.TYPE_DEFAULT,
                                            title: "Error",
                                            message: "Error occurred. Please try again."
                                        });
                                        $("#spinnerDiv").html("");
                                    }
                                });
                            };
                        }
                    });

                };
            })();
            tdFour.appendChild(buttonTwo);
            tr.appendChild(tdFour);
            tableBody.appendChild(tr);

            tableDiv.appendChild(table);
        };
    }

    function loadCurrentTable() {
        $("#existingLabel").html("Existing Users (" + current.length + ")");

        var tableDiv = document.getElementById("existingUsers");
        var table = document.createElement("TABLE");
        var tableBody = document.createElement("TBODY");

        table.appendChild(tableBody);
        table.className = "table table-striped";
        table.id = "userTable";

        var heading = new Array();
        heading[0] = "Last Name";
        heading[1] = "First Name";
        heading[2] = "Username";
        heading[3] = "E-Mail";
        heading[4] = "User Type";
        heading[5] = "Change Type";
        heading[6] = "Action";

        //TABLE COLUMNS

        var tr = document.createElement("TR");
        tableBody.appendChild(tr);

        $("#existingUsers").html("");

        for (var i = 0; i < heading.length; i++) {
            var th = document.createElement("TH");
            th.width = '15%';
            th.appendChild(document.createTextNode(heading[i]));
            tr.appendChild(th);
        }
        ;

        window.existingUserArray = new Array();

        for (var i = 0; i < current.length; i++) {
            var tr = document.createElement("TR");
            var tdTwo = document.createElement("TD");
            tdTwo.appendChild(document.createTextNode(current[i]["lastName"]));
            tr.appendChild(tdTwo);

            var tdOne = document.createElement("TD");
            tdOne.appendChild(document.createTextNode(current[i]["firstName"]));
            tr.appendChild(tdOne);

            var tdOne = document.createElement("TD");
            if (current["verified"] === 0) {
                tdOne.appendChild(document.createTextNode(current[i]["username"] + " - UNVERIFIED"));
                tdOne.style.color = "red";
            } else {
                tdOne.appendChild(document.createTextNode(current[i]["username"]));
            }
            tr.appendChild(tdOne);

            var tdOther = document.createElement("TD");
            tdOther.innerHTML = '<a href="mailto:' + current[i]["email"] + '">' + current[i]["email"] + '</a>';
            tr.appendChild(tdOther);

            var tdType = document.createElement("TD");
            tdType.appendChild(document.createTextNode(current[i]["userType"]));
            tr.appendChild(tdType);

            var tdThree = document.createElement("TD");
            var selectList = document.createElement("SELECT");
            selectList.name = "typeSelect";
            var option = document.createElement("option");
            option.value = -1;
            option.text = "NONE SELECTED";
            selectList.appendChild(option);

            // TODO - do not hardcode this array - what if we add another role down the road?

            var theArray = ["Developer", "Administration", "Faculty", "Lunch Manager", "Student"];

            for (var j = 0; j < theArray.length; j++) {
                var option = document.createElement("option");
                option.value = j;
                option.text = theArray[j];
                selectList.appendChild(option);
            }
            selectList.onchange = (function () {

                var count = i;

                return function (e) {

                    var index = this.selectedIndex - 1;

                    BootstrapDialog.confirm({
                        title: 'Confirmation',
                        message: 'Are you sure you want to update this user?',
                        type: BootstrapDialog.TYPE_DANGER, // <-- Default value is BootstrapDialog.TYPE_PRIMARY
                        closable: true, // <-- Default value is false
                        draggable: true, // <-- Default value is false
                        btnCancelLabel: 'No', // <-- Default value is 'Cancel',
                        btnOKLabel: 'Yes', // <-- Default value is 'OK',
                        btnOKClass: 'btn-primary', // <-- If you didn't specify it, dialog type will be used,
                        callback: function (result) {
                            // result will be true if button was click, while it will be false if users close the dialog directly.
                            if (result) {
                                var key = theArray[index];

                                $("#spinnerDiv").html('<a><img src="./../spinner.gif" alt="Logo" width="40" style="vertical-align: middle; padding-top:12px; padding-left:10px;"/></a>');

                                Parse.Cloud.run('updateType', {
                                    "username": structures[count].get("username"),
                                    "type": key
                                }, {
                                    success: function () {
                                        $("#spinnerDiv").html("");
                                        var alertString = "User successfully updated.";
                                        localStorage.setItem("userAlertString", alertString);
                                        $(document).ready(loadNewUserTable());
                                        $(document).ready(loadExistingUserTable());
                                    },
                                    error: function (error) {
                                        errorFunction(error.code.toString() + " - " + error.message.toString(), "ParseError", "Script 1659");
                                        BootstrapDialog.show({
                                            type: BootstrapDialog.TYPE_DEFAULT,
                                            title: "Error",
                                            message: "Error occurred. Please try again."
                                        });
                                        $("#spinnerDiv").html("");
                                    }
                                });
                            }
                            ;
                        }
                    });

                };
            })();
            tdThree.appendChild(selectList);
            tr.appendChild(tdThree);

            var tdFour = document.createElement("TD");
            var button = document.createElement("INPUT");
            button.type = "button";
            button.className = "btn btn-lg btn-primary";
            button.value = "Delete";
            button.name = i;
            button.style.marginRight = "10px";
            button.style.backgroundColor = "red";
            button.style.borderColor = "red";
            button.onclick = (function () {
                var count = i;

                return function (e) {

                    BootstrapDialog.confirm({
                        title: 'Confirmation',
                        message: 'Are you sure you want to delete this user?',
                        type: BootstrapDialog.TYPE_DANGER, // <-- Default value is BootstrapDialog.TYPE_PRIMARY
                        closable: true, // <-- Default value is false
                        draggable: true, // <-- Default value is false
                        btnCancelLabel: 'No', // <-- Default value is 'Cancel',
                        btnOKLabel: 'Yes', // <-- Default value is 'OK',
                        btnOKClass: 'btn-primary', // <-- If you didn't specify it, dialog type will be used,
                        callback: function (result) {
                            // result will be true if button was click, while it will be false if users close the dialog directly.
                            if (result) {
                                var user = window.existingUserArray[count];

                                if (user.get("username") != Parse.User.current().get("username").toString()) {
                                    $("#spinnerDiv").html('<a><img src="./../spinner.gif" alt="Logo" width="40" style="vertical-align: middle; padding-top:12px; padding-left:10px;"/></a>');

                                    Parse.Cloud.run('deleteUser', {"username": user.get("username")}, {
                                        success: function () {
                                            $("#spinnerDiv").html("");
                                            var alertString = "User successfully deleted.";
                                            $('#userAlertDiv').html('<div class="alert alert-success fade in"><a href="#" class="close" data-dismiss="alert" aria-label="close">Close</a><strong>' + alertString + '</strong></div>');
                                            $('#userAlertDiv').delay(5000).fadeOut(500);
                                            $(document).ready(loadNewUserTable());
                                            $(document).ready(loadExistingUserTable());
                                        },
                                        error: function (error) {
                                            errorFunction(error.code.toString() + " - " + error.message.toString(), "ParseError", "Script 1718");
                                            BootstrapDialog.show({
                                                type: BootstrapDialog.TYPE_DEFAULT,
                                                title: "Error",
                                                message: "Error occurred. Please try again."
                                            });
                                            $("#spinnerDiv").html("");
                                        }
                                    });
                                } else {
                                    BootstrapDialog.show({
                                        type: BootstrapDialog.TYPE_DEFAULT,
                                        title: "Error",
                                        message: "Whoops! You cannot delete yourself as a user."
                                    });
                                    $("#spinnerDiv").html("");
                                }
                                ;
                            }
                            ;
                        }
                    });

                };
            })();
            tdFour.appendChild(button);
            tr.appendChild(tdFour);
            tableBody.appendChild(tr);

            tableDiv.appendChild(table);
        }
    }

    $(document).on('click', ".approve", function() {
        var index = this.name;
        var username = requests[index]["username"];

        BootstrapDialog.confirm({
            title: 'Confirmation',
            message: 'Are you sure you want to approve this user?',
            type: BootstrapDialog.TYPE_DANGER, // <-- Default value is BootstrapDialog.TYPE_PRIMARY
            closable: true, // <-- Default value is false
            draggable: true, // <-- Default value is false
            btnCancelLabel: 'No', // <-- Default value is 'Cancel',
            btnOKLabel: 'Yes', // <-- Default value is 'OK',
            btnOKClass: 'btn-primary', // <-- If you didn't specify it, dialog type will be used,
            callback: function(result) {
                // result will be true if button was click, while it will be false if users close the dialog directly.
                if(result) {
                    $("#loading").fadeIn();
                    setLoadingMessage("Approving user...");
                    $.ajax({
                        url: "manage/ajax/approve",
                        type: "post",
                        data: { username: username },
                        datatype: 'json',
                        crossDomain: true,

                        success: function(response){
                            setLoadingMessage("Reloading users...");
                            if (response["res"] == "SUCCESS") {
                                loadPage("User successfully approved.");
                            } else {
                                setMessage("Unable to approve user. Please try to reload the page.", true);
                                $("#loading").fadeOut();
                            }
                        },

                        error: function(request, status, error) {
                            setMessage("Internal server error. If this problem continues, please contact support.", true);
                            $("#loading").fadeOut();
                        }
                    });
                };
            }
        });
    });

    $(document).on('click', ".deny", function () {
        var count = this.name;
        var ID = requests[count]["articleID"];
        var name = requests[count]["userString"];
        var e = requests[count]["email"];
        var title = requests[count]["titleString"];
        var admin = "<%= model.object.user.firstName %> <%= model.object.user.lastName %>";
        var adminMail = "<%= model.object.user.email %>";

        BootstrapDialog.show({
            title: 'Confirmation',
            message: function(dialogItself) {
                var $form = $('<form></form>');
                var $message = $('<textarea class="form-control" maxlength="400" rows="4" style="overflow-y: scroll; resize: none; width:100%;"></textarea>');
                dialogItself.setData('message', $message);
                $form.append('Are you sure you want to deny this Wildcat News Story? Please enter a brief message explaining the reason for the denial. This will be sent in an e-mail to the story\'s creator, '+name+', as well as to your e-mail for reference.<br><br><label>Message</label><br>').append($message);
                return $form;
            },// <-- Default value is BootstrapDialog.TYPE_PRIMARY
            closable: false, // <-- Default value is false
            draggable: true, // <-- Default value is false
            buttons: [{
                label: 'Cancel',
                action: function (dialogItself) {
                    dialogItself.close();
                }
            }, {
                label: 'Deny',
                cssClass: 'btn-primary',
                action: function (dialogItself) {
                    var text = dialogItself.getData('message').val();
                    $("#loading").fadeIn();
                    setLoadingMessage("Denying news article...");
                    dialogItself.close();
                    $.ajax({
                        url: "manage/ajax/deny",
                        type: "post",
                        data: { "ID": ID, "name" : name , "email" : e , "message" : text , "title" : title , "admin" : admin , "adminMail" : adminMail }, // Encrypt all data...
                        datatype: 'json',
                        crossDomain: true,

                        success: function(response){
                            dialogItself.close();
                            setLoadingMessage("Reloading news stories...");
                            if (response["res"] == "SUCCESS") {
                                loadPage("Story successfully denied. You will receive an e-mail with the denial message, for your reference.");
                            } else {
                                setMessage("Unable to deny news story. Please try to reload the page.", true);
                                $("#loading").fadeOut();
                            }
                        },

                        error: function(request, status, error) {
                            setMessage("Internal server error. If this problem continues, please contact support.", true);
                            $("#loading").fadeOut();
                        }
                    });
                }
            }]
        });
    });

    $(document).on('click', ".delete", function() {
        var index = this.name;
        var ID = current[index]["articleID"];
        BootstrapDialog.confirm({
            title: 'Confirmation',
            message: 'Are you sure you want to delete this story?',
            type: BootstrapDialog.TYPE_DANGER, // <-- Default value is BootstrapDialog.TYPE_PRIMARY
            closable: true, // <-- Default value is false
            draggable: true, // <-- Default value is false
            btnCancelLabel: 'No', // <-- Default value is 'Cancel',
            btnOKLabel: 'Yes', // <-- Default value is 'OK',
            btnOKClass: 'btn-primary', // <-- If you didn't specify it, dialog type will be used,
            callback: function(result) {
                // result will be true if button was click, while it will be false if users close the dialog directly.
                if(result) {
                    $("#loading").fadeIn();
                    setLoadingMessage("Deleting news story...");
                    $.ajax({
                        url: "manage/ajax/delete",
                        type: "post",
                        data: { ID: ID },
                        datatype: 'json',
                        crossDomain: true,

                        success: function(response){
                            setLoadingMessage("Reloading news stories...");
                            if (response["res"] == "SUCCESS") {
                                loadPage("Story successfully deleted.");
                            } else {
                                setMessage("Unable to delete news story. Please try to reload the page.", true);
                                $("#loading").fadeOut();
                            }
                        },

                        error: function(request, status, error) {
                            setMessage("Internal server error. If this problem continues, please contact support.", true);
                            $("#loading").fadeOut();
                        }
                    });
                };
            }
        });

        $('#search').keyup(function() {

            var $rows = $('#userTable tr');

            $rows.splice(0, 1);

            var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();

            $rows.show().filter(function() {
                var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
                return !~text.indexOf(val);
            }).hide();
        });
    });

</script>